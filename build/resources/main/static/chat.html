<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Spring WebSocket Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>

    <style>
        #chat { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .message { margin-bottom: 5px; }
    </style>
</head>
<body>
<h2>WebSocket STOMP 채팅 테스트</h2>

<div>
    <label for="roomId">채팅방 ID:</label>
    <input type="text" id="roomId" value="test-room" readonly>
</div>
<div>
    <label for="sender">사용자 이름:</label>
    <input type="text" id="sender" value="Guest" required>
    <button onclick="connect()">채팅 시작</button>
    <button onclick="disconnect()" disabled id="disconnectButton">채팅 종료</button>
</div>

<hr>

<div id="chat"></div>

<div>
    <input type="text" id="messageInput" placeholder="메시지를 입력하세요..." disabled>
    <button onclick="sendMessage()" disabled id="sendButton">전송</button>
</div>

<script type="text/javascript">
    let stompClient = null;
    let currentRoomId = document.getElementById('roomId').value;

    // 1. 웹소켓 연결 시도
    function connect() {

        if (stompClient && stompClient.connected) {
        console.warn("이미 연결되어 있습니다.");
        return;
        }

        const sender = document.getElementById('sender').value;
        if (!sender) {
            alert("사용자 이름을 입력하세요.");
            return;
        }

        // SockJS를 사용하여 웹소켓 연결
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            console.log('Connected: ' + frame);

            // UI 상태 변경
            document.getElementById('disconnectButton').disabled = false;
            document.getElementById('sendButton').disabled = false;
            document.getElementById('messageInput').disabled = false;

            // 2. 채팅방 구독
            // 서버의 '/sub/chat/room/{roomId}' 경로를 구독하여 메시지를 수신합니다.
            stompClient.subscribe('/sub/chat/room/' + currentRoomId, function (message) {
                console.log("받은 메시지:", message.body);
                showMessage(JSON.parse(message.body));
            });

            // 3. 입장 메시지 발행
            sendMessage('ENTER');

        }, function (error) {
            console.error("STOMP Error:", error);
            alert("채팅 서버 연결에 실패했습니다.");
        });
    }

    // 4. 웹소켓 연결 해제
    function disconnect() {
        if (stompClient !== null) {
            // 퇴장 메시지 전송 후 연결 해제
            sendMessage('QUIT');
            stompClient.disconnect();
        }
        console.log("Disconnected");
        // UI 상태 변경
        document.getElementById('disconnectButton').disabled = true;
        document.getElementById('sendButton').disabled = true;
        document.getElementById('messageInput').disabled = true;
    }

    // 5. 메시지 전송 (TALK 또는 ENTER/QUIT)
   function sendMessage(type) {
        const sender = document.getElementById('sender').value;
        let messageContent;

        // **[수정] type 인자가 제공되지 않았을 경우, 기본적으로 'TALK'로 설정**
        type = type || 'TALK';

        if (type === 'TALK') {
            // **[핵심 수정] 메시지 입력 필드의 값을 정확히 가져옵니다.**
            messageContent = document.getElementById('messageInput').value.trim();

            // 메시지 내용이 비어 있으면 전송하지 않음
            if (!messageContent) return;
        } else {
            // ENTER, QUIT 메시지는 내용이 비어있어도 됨
            messageContent = "";
        }

        if (stompClient && stompClient.connected) {
            const chatMessage = {
                type: type,
                roomId: currentRoomId,
                sender: sender,
                message: messageContent // 여기에 메시지 내용이 포함됩니다.
            };

            // 서버의 '/pub/chat/message' 경로로 메시지를 발행
            stompClient.send("/pub/chat/message", {}, JSON.stringify(chatMessage));

            // 입력창 초기화
            if (type === 'TALK') {
                document.getElementById('messageInput').value = '';
            }
        } else {
            alert('서버에 연결되지 않았습니다.');
        }
    }

    // 6. 메시지 화면 표시
    function showMessage(chatMessage) {
        const chatDiv = document.getElementById('chat');
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        let displayText = `[${chatMessage.sender}] ${chatMessage.message}`;

        if (chatMessage.type === 'ENTER') {
            displayText = `--- ${chatMessage.message} ---`;
        } else if (chatMessage.type === 'QUIT') {
            displayText = `--- ${chatMessage.sender}님이 퇴장하셨습니다. ---`;
        }

        messageElement.textContent = displayText;
        chatDiv.appendChild(messageElement);
        // 스크롤을 항상 아래로 이동
        chatDiv.scrollTop = chatDiv.scrollHeight;
    }
</script>
</body>
</html>